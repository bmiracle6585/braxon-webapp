<!DOCTYPE html>
<html lang="en">
<head>
    <script src="js/auth.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Details - Braxon Industries</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="dashboard-page">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-content">
            <!-- Logo -->
            <div class="sidebar-logo">
                <img src="assets/logo.svg" alt="Braxon Industries Logo" class="braxon-logo-sidebar">
            </div>

            <!-- Navigation -->
            <nav class="sidebar-nav">
                <a href="dashboard" class="nav-item">
                    <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    <span>Dashboard</span>
                </a>
                
                <a href="projects" class="nav-item active">
                    <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                    </svg>
                    <span>Projects</span>
                </a>

                <a href="tech-portal" class="nav-item" id="techPortalNavLink">
                    <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                    </svg>
                    <span>Tech Portal</span>
                    <svg class="lock-icon" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="display: none; margin-left: auto;">
                        <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
                    </svg>
                </a>

                <a href="/admin-console" class="nav-item" id="adminLink" style="display: none;">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span class="nav-text">Admin Console</span>
                </a>
            </nav>

            <!-- User Profile & Sign Out -->
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-name">Blake Miracle</div>
                    <div class="user-email">bmiracle6585@gmail.com</div>
                    <div class="user-role">Admin</div>
                </div>
                <button class="btn-signout" onclick="logout()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    <span>Sign Out</span>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-wrapper">
            <!-- Back Button -->
            <div class="back-navigation">
                <a href="projects.html" class="back-link">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Back to Projects
                </a>
            </div>

            <!-- 1. Project Name & Status Badge -->
            <header class="project-details-header">
                <div>
                    <h1 class="project-details-title" id="projectTitle">Loading...</h1>
                    <span class="badge badge-blue" id="projectStatusBadge">Loading</span>
                </div>
                <div class="header-actions">
                    <button id="deleteProjectBtn" class="btn-danger" onclick="confirmDeleteProject()" style="display: none;">
                        <i class="fas fa-trash-alt"></i> Delete Project
                    </button>
                </div>
            </header>

            <!-- 2. Project Status Section -->
            <div class="section-card">
                <h2 class="section-title">Project Status</h2>
                <p class="section-subtitle">Current project execution status</p>
                
                <div class="project-status-selector">
                    <select id="projectStatusSelect" class="status-select-large">
                        <option value="" disabled selected>Select Status</option>
                        <option value="pending">Pending</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="on_hold">On Hold</option>
                    </select>
                </div>
            </div>

            <!-- 3. Project Information Section -->
            <div class="section-card">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Project Information</h2>
                    </div>
                    <div class="project-info-actions">
                        <button class="btn-icon" id="uploadDocsBtn" title="Upload Documents">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            Upload Documents
                        </button>
                        <button class="btn-outline" id="editSiteInfoBtn" onclick="openEditModal()">Edit Site Info</button>
                    </div>
                </div>

                <!-- Uploaded Documents List -->
                <div class="documents-list" id="documentsList">
                    <!-- Documents will be loaded dynamically -->
                </div>

                <!-- Site Information Grid -->
                <div class="site-info-grid">
                    <div class="site-column">
                        <h3 class="site-column-title">Site A Name</h3>
                        <p class="site-value" id="siteAName">-</p>
                        
                        <h3 class="site-column-title">Site A Location</h3>
                        <div class="site-value-with-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            <span id="siteALocation">-</span>
                        </div>

                        <h3 class="site-column-title">Start Date</h3>
                        <div class="site-value-with-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            <span id="startDate">-</span>
                        </div>
                    </div>

                    <div class="site-column">
                        <h3 class="site-column-title">Site B Name</h3>
                        <p class="site-value" id="siteBName">-</p>
                        
                        <h3 class="site-column-title">Site B Location</h3>
                        <div class="site-value-with-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            <span id="siteBLocation">-</span>
                        </div>

                        <h3 class="site-column-title">Expected Completion</h3>
                        <div class="site-value-with-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            <span id="endDate">-</span>
                        </div>
                    </div>
                </div>

                <!-- Scope of Work & Budget Summary -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">
                    
                    <!-- Left Column: Scope of Work (Condensed) -->
                    <div class="scope-of-work">
                        <h3 class="scope-title">Scope of Work Summary</h3>
                        <div class="scope-badges">
                            <span class="scope-badge">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                </svg>
                                <span id="scopeOfWork">-</span>
                            </span>
                            <span class="scope-count">1 Scope</span>
                        </div>
                        <p class="scope-note" style="font-size: 12px; margin-top: 8px;">Scopes drive milestone checklists. Contact PM to modify.</p>
                    </div>

                    <!-- Right Column: Hours Budget -->
                    <div class="budget-summary">
                        <h3 style="font-size: 16px; font-weight: 600; color: #1e293b; margin: 0 0 12px 0;">
                            üí∞ Hours Budget
                        </h3>
                        
                        <!-- Progress Bar -->
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span style="font-size: 13px; color: #64748b;">Budget Usage</span>
                                <span style="font-size: 13px; font-weight: 600; color: #1e293b;" id="budgetPercentage">0%</span>
                            </div>
                            <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="budgetProgressBar" style="background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%); height: 100%; width: 0%; transition: all 0.3s;"></div>
                            </div>
                        </div>

                        <!-- Budget Stats Grid -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px;">
                            <div style="background: #f8fafc; padding: 10px; border-radius: 6px; text-align: center;">
                                <p style="font-size: 11px; color: #64748b; margin: 0 0 4px 0; text-transform: uppercase; font-weight: 500;">Total Budget</p>
                                <p style="font-size: 18px; font-weight: 700; color: #1e293b; margin: 0;" id="totalBudgetHours">0</p>
                                <p style="font-size: 11px; color: #64748b; margin: 0;">hours</p>
                            </div>
                            <div style="background: #fef3c7; padding: 10px; border-radius: 6px; text-align: center;">
                                <p style="font-size: 11px; color: #92400e; margin: 0 0 4px 0; text-transform: uppercase; font-weight: 500;">Hours Used</p>
                                <p style="font-size: 18px; font-weight: 700; color: #92400e; margin: 0;" id="usedHours">0</p>
                                <p style="font-size: 11px; color: #92400e; margin: 0;">hours</p>
                            </div>
                            <div style="background: #dcfce7; padding: 10px; border-radius: 6px; text-align: center;">
                                <p style="font-size: 11px; color: #166534; margin: 0 0 4px 0; text-transform: uppercase; font-weight: 500;">Remaining</p>
                                <p style="font-size: 18px; font-weight: 700; color: #166534; margin: 0;" id="remainingHours">0</p>
                                <p style="font-size: 11px; color: #166534; margin: 0;">hours</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Project Description (Moved Below) -->
                <div class="project-description-section">
                    <h3 class="description-title">Project Description</h3>
                    <p class="description-text" id="projectDescription">-</p>
                </div>
            </div>

            <!-- Deployment Team Section -->
            <div class="info-card" style="margin-top: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1.25rem; font-weight: 700; color: #1e293b; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #DC143C;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        Deployment Team
                    </h3>
                    <div style="display: flex; gap: 0.5rem;">
  <button
    id="addTeamMemberBtn"
    type="button"
    style="padding: 0.5rem 1rem; font-size: 0.875rem; background: #DC2626; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem;">
    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
    </svg>
    Add Team Member
  </button>

  <button
    id="editTeamBtn"
    type="button"
    style="padding: 0.5rem 1rem; font-size: 0.875rem; background: #2B5B8E; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: none; align-items: center; gap: 0.5rem;">
    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
    </svg>
    Edit Team
  </button>
</div>
                </div>

                <!-- Team Members Grid -->
                <div id="teamMembersList">
                    <div style="text-align: center; padding: 3rem; color: #64748b;">
                        <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 1rem; opacity: 0.3;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        <p style="font-size: 1rem; margin-bottom: 0.5rem; font-weight: 600;">No team members assigned yet</p>
                        <p style="font-size: 0.875rem; color: #94a3b8; margin-bottom: 1.5rem;">
                            Team members will have mobile access to this project
                        </p>
                    </div>
                </div>
            </div>

            <!-- Team Management Modal -->
            <div id="teamModalOverlay" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div class="modal-content" style="background: white; border-radius: 16px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <div class="modal-header" style="padding: 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: #1e293b;">Manage Team</h2>
                        <button class="close-modal" onclick="closeTeamModal()" style="background: none; border: none; font-size: 2rem; color: #64748b; cursor: pointer; line-height: 1; padding: 0; width: 32px; height: 32px;">&times;</button>
                    </div>
                    
                    <div class="modal-body" style="padding: 1.5rem;">
                        <!-- Add Team Member Form -->
                        <div style="background: #f8fafc; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem;">Add Team Member</h3>
                            
                            <form id="addTeamMemberForm" style="display: grid; gap: 1rem;">
                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #475569; margin-bottom: 0.5rem;">
                                        Team Member <span style="color: #dc2626;">*</span>
                                    </label>
                                    <select id="teamMemberSelect" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                                        <option value="">Select a Braxon employee...</option>
                                    </select>
                                </div>

                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #475569; margin-bottom: 0.5rem;">
                                        Role on Project <span style="color: #dc2626;">*</span>
                                    </label>
                                    <select id="teamRoleSelect" required style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                                        <option value="technician">Technician</option>
                                        <option value="lead">Team Lead</option>
                                        <option value="supervisor">Supervisor</option>
                                    </select>
                                </div>

                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #475569; margin-bottom: 0.5rem;">
                                        Notes (Optional)
                                    </label>
                                    <textarea id="teamNotes" rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; resize: vertical;" placeholder="Special requirements, certifications, etc."></textarea>
                                </div>

                                <button type="submit" style="width: 100%; padding: 1rem; background: #DC143C; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                    </svg>
                                    Add to Team
                                </button>
                            </form>
                        </div>

                        <!-- Current Team Members List -->
                        <div>
                            <h3 style="font-size: 1rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem;">
                                Current Team Members
                                <span style="font-size: 0.75rem; color: #64748b; font-weight: 400;">(Mobile access enabled)</span>
                            </h3>
                            <div id="currentTeamList" style="display: flex; flex-direction: column; gap: 0.75rem;">
                                <p style="text-align: center; color: #94a3b8; padding: 1rem;">No team members yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Daily Reports Section -->
            <div class="card mb-5" style="border: 2px solid #dee2e6; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 40px;">
                <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; padding: 15px;">
                    <h5 class="mb-0">üìã Daily Reports</h5>
                    <button class="btn btn-primary btn-sm" id="submitDailyReportBtn" onclick="openMobileProjectCard()">
                        <i class="fas fa-plus"></i> Submit Daily Report
                    </button>
                </div>
                <div class="card-body" style="background-color: white; padding: 20px;">
                    <div id="latestDailyReportContainer" style="padding: 40px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; min-height: 350px;">
                        <div class="text-center text-muted py-3">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 mb-0">Loading daily reports...</p>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <a href="#" id="viewAllReportsLink" class="btn btn-outline-primary btn-sm" onclick="viewAllReports(event)">
                            View All Reports ‚Üí
                        </a>
                    </div>
                </div>
            </div>

            <!-- ‚úÖ UPDATED: Change Orders & Concerns Section -->
            <div class="section-card">
                <div class="section-warning-header">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    <h2 class="section-title">Change Orders & Concerns</h2>
                </div>
                <p class="section-subtitle">Issues, complications, or upscopes reported by the field team</p>

                <!-- NEW: Field-Reported Issues from Daily Reports -->
                <div id="fieldReportedIssues" style="margin-bottom: 24px;">
                    <h3 style="font-size: 14px; font-weight: 600; color: #1e293b; margin-bottom: 12px;">
                        Field-Reported Issues
                    </h3>
                    <div id="concernsList">
                        <!-- Concerns will be loaded here -->
                        <div style="text-align: center; padding: 20px; color: #94a3b8;">
                            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="opacity: 0.5; margin-bottom: 8px;">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="16" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12.01" y2="8"></line>
                            </svg>
                            <p style="margin: 0;">Loading concerns...</p>
                        </div>
                    </div>
                </div>

                <!-- Existing Internal Notes Section -->
                <div class="internal-notes-section">
                    <h3 class="concerns-subtitle">Additional Notes (Internal)</h3>
                    <textarea 
                        id="internalNotes" 
                        placeholder="Add internal notes about change orders, resolutions, or action items..." 
                        rows="5"
                        class="internal-notes-textarea"
                    ></textarea>
                    <button class="btn-primary" onclick="saveChangeOrderNotes()">Save Notes</button>
                </div>
            </div>

            <!-- Project Readiness -->
            <div class="readiness-grid">
                <div class="readiness-card">
                    <div class="readiness-header">
                        <div class="readiness-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                        </div>
                        <div class="readiness-title-section">
                            <h3 class="readiness-title">Project Authorization</h3>
                            <p class="readiness-subtitle">Contractual approvals and authorization status</p>
                        </div>
                        <div class="readiness-percentage">
                            <span class="percentage-value">0%</span>
                            <span class="percentage-label">Complete</span>
                        </div>
                    </div>

                    <div class="readiness-progress">
                        <div class="readiness-stats">
                            <span class="stats-label">0 of 9</span>
                            <span class="stats-description">Authorization items complete</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%;"></div>
                        </div>
                    </div>

                    <a href="project-authorization.html" class="readiness-link">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                        View & Update Authorization
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </a>

                    <p class="readiness-note">Track PO, NTP, construction authorization, and closeout milestones</p>
                </div>

                <div class="readiness-card">
                    <div class="readiness-header">
                        <div class="readiness-icon readiness-icon-execution">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                            </svg>
                        </div>
                        <div class="readiness-title-section">
                            <h3 class="readiness-title">Execution Readiness</h3>
                            <p class="readiness-subtitle">Dependencies and prerequisites for construction</p>
                        </div>
                        <div class="readiness-percentage">
                            <span class="percentage-value">0%</span>
                            <span class="percentage-label">Ready</span>
                        </div>
                    </div>

                    <div class="readiness-progress">
                        <div class="readiness-stats">
                            <span class="stats-label">0 of 5</span>
                            <span class="stats-description">Readiness items complete</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%;"></div>
                        </div>
                    </div>

                    <a href="execution-readiness.html" class="readiness-link">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                        </svg>
                        View & Update Readiness
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </a>

                    <p class="readiness-note">Monitor materials, site access, testing, and MOP status</p>
                </div>
            </div>

            <!-- Photo Documentation -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title-with-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        <div>
                            <h2 class="section-title">Photo Documentation</h2>
                            <p class="section-subtitle">Multi-site installation photo checklist</p>
                        </div>
                    </div>
                    
                    <a href="#" id="siteModuleEntryLink" class="manage-closeout-link">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 7h-9"></path>
                            <path d="M14 17H5"></path>
                            <circle cx="17" cy="17" r="3"></circle>
                            <circle cx="7" cy="7" r="3"></circle>
                        </svg>
                        <span>Site Module Entry</span>
                    </a>
                </div>

                <div class="photo-doc-summary">
                    <div class="photo-doc-header">
                        <span class="photo-doc-label">Overall Completion</span>
                        <span class="photo-doc-percentage">0%</span>
                    </div>
                    <div class="progress-bar-large">
                        <div class="progress-fill" style="width: 0%;"></div>
                    </div>
                    <p class="photo-doc-stats">0 of 0 required photos satisfied</p>
                    <p class="photo-doc-modules">0 modules configured</p>
                </div>

                <div class="site-photo-grid">
                    <div class="site-photo-column">
                        <div class="site-indicator site-a"></div>
                        <span class="site-name" id="photoDocSiteAName">Site A</span>
                        <span class="site-modules" id="photoDocSiteAModules">0 modules</span>
                    </div>
                    <div class="site-photo-column">
                        <div class="site-indicator site-b"></div>
                        <span class="site-name" id="photoDocSiteBName">Site B</span>
                        <span class="site-modules" id="photoDocSiteBModules">0 modules</span>
                    </div>
                </div>

                <!-- Closeout Summary -->
                <div class="closeout-summary-grid">
                    <div class="closeout-summary-card">
                        <div class="closeout-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                        </div>
                        <div class="closeout-summary-content">
                            <span class="closeout-label">Photos</span>
                            <span class="closeout-value">0 / 0 required photos satisfied</span>
                            <span class="closeout-meta">0 / 0 modules complete</span>
                        </div>
                    </div>

                    <div class="closeout-summary-card">
                        <div class="closeout-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                <line x1="8" y1="21" x2="16" y2="21"></line>
                                <line x1="12" y1="17" x2="12" y2="21"></line>
                            </svg>
                        </div>
                        <div class="closeout-summary-content">
                            <span class="closeout-label">Screen Captures</span>
                            <span class="closeout-value">0</span>
                            <span class="closeout-meta">uploaded</span>
                        </div>
                    </div>

                    <div class="closeout-summary-card">
                        <div class="closeout-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M12 1v6m0 6v6m8.66-9.66l-5.2 3m-6.92 4l-5.2 3M1.34 9.66l5.2 3m6.92 4l5.2 3"></path>
                            </svg>
                        </div>
                        <div class="closeout-summary-content">
                            <span class="closeout-label">Config Files</span>
                            <span class="closeout-value">0</span>
                            <span class="closeout-meta">uploaded</span>
                        </div>
                    </div>
                </div>

<div class="closeout-status">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="16" x2="12" y2="12"></line>
        <line x1="12" y1="8" x2="12.01" y2="8"></line>
    </svg>
    <span>Closeout inputs not yet configured (0% ready)</span>
</div>

<a href="#" id="manageCloseoutLink" class="manage-closeout-link">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 7h-9"></path>
        <path d="M14 17H5"></path>
        <circle cx="17" cy="17" r="3"></circle>
        <circle cx="7" cy="7" r="3"></circle>
    </svg>
    Manage Closeout
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
</a>

<p class="closeout-note">Upload screen captures, config files, and generate closeout packages</p>

            </div>
        </div>
    </main>

    <!-- Edit Site Info Modal -->
    <div id="editSiteModal" class="modal-overlay" style="display: none;">
        <div class="modal-container modal-large">
            <div class="modal-header">
                <h2 class="modal-title">Edit Project Information</h2>
                <button class="modal-close" onclick="closeEditModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <form id="editProjectForm" class="project-form" onsubmit="saveProjectChanges(event)">
                <input type="hidden" id="editProjectId">

                <!-- Row 1: Customer and POC -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="editCustomerCompany">Customer Company *</label>
                        <select id="editCustomerCompany" required>
                            <option value="">Select company...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="editCustomerContact">Customer Contact *</label>
                        <select id="editCustomerContact" required>
                            <option value="">Select company first...</option>
                        </select>
                        <small class="form-hint">POC list is filtered by selected customer</small>
                    </div>
                </div>

                <!-- Row 2: Project Name and Scope of Work -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="editProjectName">Project Name *</label>
                        <input type="text" id="editProjectName" placeholder="Enter project name" required>
                    </div>
                    <div class="form-group">
                        <label for="editScopeOfWork">Scope of Work</label>
                        <select id="editScopeOfWork">
                            <option value="">Select scope...</option>
                            <option value="New Installation">New Installation</option>
                            <option value="Upgrade">Upgrade</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Decommission">Decommission</option>
                            <option value="Survey">Survey</option>
                        </select>
                    </div>
                </div>

                <!-- Row 3: Status and Hours Budget -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="editProjectStatus">Status</label>
                        <select id="editProjectStatus">
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="on_hold">On Hold</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editHoursBudget">Hours Budget</label>
                        <input type="number" id="editHoursBudget" placeholder="Estimated hours" step="0.5">
                    </div>
                </div>

                <!-- Row 4: Site Names -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="editSiteAName">Site A Name *</label>
                        <input type="text" id="editSiteAName" placeholder="Site A name" required>
                    </div>
                    <div class="form-group">
                        <label for="editSiteBName">Site B Name</label>
                        <input type="text" id="editSiteBName" placeholder="Site B name (optional)">
                    </div>
                </div>

                <!-- Row 5: Site Locations -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="editSiteALocation">Site A Location (DMS) *</label>
                        <input type="text" id="editSiteALocation" placeholder="34 27 54.93, -109 37 41.59" required>
                        <small class="form-hint">Format: DD MM SS.SS, -DDD MM SS.SS</small>
                    </div>
                    <div class="form-group">
                        <label for="editSiteBLocation">Site B Location (DMS)</label>
                        <input type="text" id="editSiteBLocation" placeholder="34 36 6.11, -109 37 44.73">
                        <small class="form-hint">Optional second site</small>
                    </div>
                </div>

                <!-- Row 6: Dates -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="editStartDate">Start Date *</label>
                        <input type="date" id="editStartDate" required>
                    </div>
                    <div class="form-group">
                        <label for="editEndDate">Expected Completion Date</label>
                        <input type="date" id="editEndDate">
                    </div>
                </div>

                <!-- Row 7: Description -->
                <div class="form-group">
                    <label for="editProjectDescription">Project Description</label>
                    <textarea id="editProjectDescription" placeholder="Project description and notes" rows="3"></textarea>
                </div>

                <!-- Form Actions -->
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeEditModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>

    <!-- Declare global variable BEFORE loading project-details.js -->
    <script>
    var currentProject = null;
</script>

   <script src="/js/project-details.js"></script>
    <script src="js/tech-portal-access.js"></script>

    <script>
        // Show admin link only for admin users
        if (localStorage.getItem('userRole') === 'admin') {
            const adminLink = document.getElementById('adminLink');
            if (adminLink) {
                adminLink.style.display = 'flex';
            }
        }

        // ============================================
        // LOAD FIELD-REPORTED CONCERNS FROM DAILY REPORTS
        // ============================================
        async function loadFieldConcerns(projectId) {
            try {
                const response = await fetch(`/api/daily-reports/project/${projectId}/concerns`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const result = await response.json();
                const concernsList = document.getElementById('concernsList');
                
                if (result.success && result.data && result.data.length > 0) {
                    concernsList.innerHTML = result.data.map(concern => {
                        const reportDate = new Date(concern.report_date).toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric', 
                            year: 'numeric' 
                        });
                        
                        return `
                            <div style="background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <div style="font-size: 12px; color: #92400e; font-weight: 600; margin-bottom: 4px;">
                                            üìÖ ${reportDate} ‚Ä¢ ${concern.reported_by_name || 'Field Team'}
                                        </div>
                                        <div style="font-size: 13px; color: #78350f; font-weight: 500; margin-bottom: 2px;">
                                            ${concern.site ? `Site: ${concern.site}` : ''}
                                        </div>
                                    </div>
                                </div>
                                <div style="font-size: 14px; color: #1e293b; line-height: 1.5; white-space: pre-wrap;">
                                    ${concern.issues_concerns}
                                </div>
                                <div style="display: flex; gap: 8px; margin-top: 12px;">
                                    <button onclick="viewFullReport(${concern.report_id})" 
                                            style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                        View Full Report
                                    </button>
                                    <button onclick="markResolved(${concern.report_id})" 
                                            style="background: #22c55e; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                        Mark Resolved
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    concernsList.innerHTML = `
                        <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 16px; text-align: center; color: #166534;">
                            <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 8px; display: block;">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <strong>N/A ‚Äì No change orders or concerns reported</strong>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading field concerns:', error);
                document.getElementById('concernsList').innerHTML = `
                    <div style="background: #fef2f2; border: 1px solid #fca5a5; border-radius: 8px; padding: 16px; text-align: center; color: #991b1b;">
                        Failed to load concerns
                    </div>
                `;
            }
        }

        function viewFullReport(reportId) {
            window.location.href = `/daily-report-view.html?id=${reportId}`;
        }

        function markResolved(reportId) {
            // TODO: Implement resolve functionality
            alert(`Mark report ${reportId} as resolved (feature coming soon)`);
        }

        // ============================================
        // EXISTING FUNCTIONS (keeping all your code)
        // ============================================

        // Load latest daily report for project
        async function loadLatestDailyReport(projectId) {
            const container = document.getElementById('latestDailyReportContainer');
            
            try {
                const response = await fetch(`/api/daily-reports/project/${projectId}/latest`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const result = await response.json();

                if (result.success && result.data) {
                    const report = result.data;
                    const reportDate = new Date(report.report_date).toLocaleDateString('en-US', {
                        weekday: 'short',
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                    const submittedBy = report.submitted_by_name || 'Unknown';
                    const submittedAt = new Date(report.created_at).toLocaleString('en-US');
                    
                    const userRole = localStorage.getItem('userRole');
                    const canManage = userRole === 'admin' || userRole === 'pm';

                    container.innerHTML = `
                        <div style="background: white; border-left: 4px solid #2563eb; padding: 20px; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                                <div>
                                    <h6 style="font-size: 16px; font-weight: 600; color: #1e293b; margin: 0 0 8px 0;">
                                        üìÖ ${reportDate} - ${report.site || 'Both Sites'}
                                    </h6>
                                    <p style="font-size: 13px; color: #64748b; margin: 0;">
                                        Submitted by <strong>${submittedBy}</strong> on ${submittedAt}
                                    </p>
                                </div>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <span style="background: #22c55e; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500;">
                                        Submitted
                                    </span>
                                    ${canManage ? `
                                        <button onclick="deleteDailyReport(${report.id})" 
                                                style="background: #fee; color: #dc2626; border: 1px solid #fecaca; padding: 6px 12px; border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 4px;"
                                                onmouseover="this.style.background='#fecaca'" 
                                                onmouseout="this.style.background='#fee'"
                                                title="Delete Report">
                                            üóëÔ∏è Delete
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
                                ${report.weather_conditions ? `
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 20px;">‚òÄÔ∏è</span>
                                        <div>
                                            <p style="font-size: 12px; color: #64748b; margin: 0;">Weather</p>
                                            <p style="font-size: 14px; color: #1e293b; font-weight: 500; margin: 0;">${report.weather_conditions}</p>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${report.crew_time ? `
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 20px;">üë•</span>
                                        <div>
                                            <p style="font-size: 12px; color: #64748b; margin: 0;">Crew</p>
                                            <p style="font-size: 14px; color: #1e293b; font-weight: 500; margin: 0;">${JSON.parse(report.crew_time).length} members</p>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${report.work_description ? `
                                <div style="background: #f8fafc; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
                                    <p style="font-size: 12px; color: #64748b; margin: 0 0 4px 0; font-weight: 500;">üìã Work Description</p>
                                    <p style="font-size: 14px; color: #334155; margin: 0; line-height: 1.5;">${report.work_description}</p>
                                </div>
                            ` : ''}
                            
                            ${report.general_notes ? `
                                <div style="background: #f8fafc; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
                                    <p style="font-size: 12px; color: #64748b; margin: 0 0 4px 0; font-weight: 500;">üìù Notes</p>
                                    <p style="font-size: 14px; color: #334155; margin: 0; line-height: 1.5;">${report.general_notes}</p>
                                </div>
                            ` : ''}
                            
                            <a href="/daily-report-detail.html?reportId=${report.id}" 
                               style="display: inline-flex; align-items: center; gap: 6px; color: #2563eb; text-decoration: none; font-size: 14px; font-weight: 500; padding: 8px 16px; border: 1px solid #2563eb; border-radius: 6px; transition: all 0.2s;"
                               onmouseover="this.style.background='#eff6ff'" 
                               onmouseout="this.style.background='transparent'">
                                View Full Report ‚Üí
                            </a>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-clipboard-list fa-3x mb-3 opacity-50"></i>
                            <p class="mb-0">${result.message || 'No daily reports submitted yet'}</p>
                            <small class="text-muted">Field technicians can submit daily reports from the mobile app</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading latest daily report:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Failed to load daily reports. Please refresh the page.
                    </div>
                `;
            }
        }

        // Calculate and display hours budget
        function displayBudgetInfo(project) {
            const totalBudget = parseFloat(project.hours_estimate) || 0;
            const hoursUsed = parseFloat(project.hours_used) || 0;
            const remaining = totalBudget - hoursUsed;
            const percentage = totalBudget > 0 ? Math.round((hoursUsed / totalBudget) * 100) : 0;

            document.getElementById('totalBudgetHours').textContent = totalBudget.toFixed(0);
            document.getElementById('usedHours').textContent = hoursUsed.toFixed(1);
            document.getElementById('remainingHours').textContent = remaining.toFixed(1);
            document.getElementById('budgetPercentage').textContent = percentage + '%';

            const progressBar = document.getElementById('budgetProgressBar');
            progressBar.style.width = percentage + '%';

            if (percentage > 90) {
                progressBar.style.background = 'linear-gradient(90deg, #ef4444 0%, #dc2626 100%)';
            } else if (percentage > 75) {
                progressBar.style.background = 'linear-gradient(90deg, #f59e0b 0%, #d97706 100%)';
            } else {
                progressBar.style.background = 'linear-gradient(90deg, #22c55e 0%, #16a34a 100%)';
            }
        }

        // Delete daily report
        async function deleteDailyReport(reportId) {
            if (!confirm('Are you sure you want to delete this daily report? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetchWithAuth(`/api/daily-reports/${reportId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('Daily report deleted successfully');
                    const urlParams = new URLSearchParams(window.location.search);
                    const projectId = urlParams.get('id');
                    await loadLatestDailyReport(projectId);
                    await loadFieldConcerns(projectId); // ‚úÖ Reload concerns
                } else {
                    alert('Failed to delete report: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete daily report');
            }
        }

        // Open daily report form
        function openMobileProjectCard() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');
            
            if (projectId) {
                window.location.href = `/mobile-project-card.html?projectId=${projectId}`;
            } else {
                alert('Project ID not found');
            }
        }

        // View all reports
        function viewAllReports(event) {
            event.preventDefault();
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');
            
            if (projectId) {
                window.location.href = `/daily-reports-list.html?projectId=${projectId}`;
            }
        }

        // Load project details
async function loadProjectDetails() {
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('id');
    
    if (!projectId) {
        alert('Project ID not found');
        window.location.href = '/projects';
        return;
    }

    try {
        const response = await fetchWithAuth(`/api/projects/${projectId}`);
        const result = await response.json();
        
        if (result.success) {
            currentProject = result.data;
            populateProjectDetails(currentProject);
            displayBudgetInfo(currentProject);
            await loadLatestDailyReport(projectId);
            await loadFieldConcerns(projectId);
            await loadCurrentTeam();
            
            // Fix Site Module Entry link
            const moduleEntryLink = document.getElementById('siteModuleEntryLink');
            if (moduleEntryLink) {
                moduleEntryLink.href = `site-module-entry.html?projectId=${projectId}`;
            }
            
            // Fix Manage Closeout link
setTimeout(() => {
    const closeoutLink = document.getElementById('manageCloseoutLink');
    console.log('üîç Looking for closeout link:', closeoutLink);
    
    if (closeoutLink) {
        closeoutLink.href = `photo-documentation.html?projectId=${projectId}&site=a`;
        console.log('‚úÖ Updated closeout link to:', closeoutLink.href);
        
        // Add click handler as backup
        closeoutLink.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('üñ±Ô∏è Closeout link clicked!');
            window.location.href = `photo-documentation.html?projectId=${projectId}&site=a`;
        });
    } else {
        console.error('‚ùå Closeout link not found!');
    }
}, 500);
            
        } else {
            alert('Failed to load project details');
            window.location.href = '/projects';
        }
    } catch (error) {
        console.error('Error loading project details:', error);
        alert('Error loading project details');
    }
}

        // Populate project details on page
        function populateProjectDetails(project) {
            document.getElementById('projectTitle').textContent = project.project_name || project.name || 'Untitled Project';
            document.getElementById('projectStatusBadge').textContent = project.status || 'Unknown';
            document.getElementById('siteAName').textContent = project.site_a_name || '-';
            document.getElementById('siteBName').textContent = project.site_b_name || '-';
            document.getElementById('siteALocation').textContent = project.site_a_location || 'Not specified';
            document.getElementById('siteBLocation').textContent = project.site_b_location || 'Not specified';
            document.getElementById('startDate').textContent = project.start_date ? new Date(project.start_date).toLocaleDateString() : '-';
            document.getElementById('endDate').textContent = project.end_date ? new Date(project.end_date).toLocaleDateString() : '-';
            document.getElementById('scopeOfWork').textContent = project.scope_of_work || 'Not specified';
            document.getElementById('projectDescription').textContent = project.description || 'No description provided';
            
            // Set status select
            document.getElementById('projectStatusSelect').value = project.status || '';
        }

        // ... REST OF YOUR EXISTING JAVASCRIPT FUNCTIONS ...
        // (All your team management, edit modal, customer dropdown functions stay exactly the same)

        // Logout function
        function logout() {
            localStorage.clear();
            window.location.href = '/';
        }

        // Page initialization
        document.addEventListener('DOMContentLoaded', loadProjectDetails);

        // [ALL YOUR REMAINING FUNCTIONS GO HERE - UNCHANGED]
        // FORCE UPDATE MANAGE CLOSEOUT LINK ON PAGE LOAD
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get('id');
    
    // Wait for page to fully render
    setTimeout(() => {
        const manageCloseoutBtn = document.getElementById('manageCloseoutLink');
        console.log('üîç Found manage closeout button:', manageCloseoutBtn);
        
        if (manageCloseoutBtn && projectId) {
            // Set the href
            manageCloseoutBtn.href = `closeout-package.html?projectId=${projectId}`;
            console.log('‚úÖ Set href to:', manageCloseoutBtn.href);
            
            // Also add click event listener
            manageCloseoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('üñ±Ô∏è Button clicked! Navigating to photo documentation...');
                window.location.href = `closeout-package.html?projectId=${projectId}`;
            });
        } else {
            console.error('‚ùå Button or projectId not found!', {manageCloseoutBtn, projectId});
        }
    }, 1000); // Wait 1 second
});
    </script>

    <!-- Keep all your remaining scripts below -->

    <!-- ========================= -->
<!-- TEAM MODAL (UI SHELL ONLY) -->
<!-- ========================= -->
<div id="teamModalOverlay" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
">
  <div id="teamModal" style="
    width: 100%;
    max-width: 720px;
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.25);
    overflow: hidden;
    margin: 0 16px;
  ">
    <div style="
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 16px;
      border-bottom: 1px solid #e5e7eb;
    ">
      <div style="display:flex; flex-direction:column; gap:2px;">
        <div style="font-weight:700; font-size: 16px; color:#111827;">Add Team Member</div>
        <div style="font-size: 12px; color:#6b7280;">(UI not wired yet)</div>
      </div>

      <button id="closeTeamModalBtn" type="button" style="
        width: 36px;
        height: 36px;
        border: none;
        background: #f3f4f6;
        border-radius: 10px;
        cursor: pointer;
        display:flex;
        align-items:center;
        justify-content:center;
      " aria-label="Close">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M18 6L6 18M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <div style="padding: 16px;">
      <div style="
        padding: 14px;
        border: 1px dashed #d1d5db;
        border-radius: 12px;
        background: #fafafa;
        color: #374151;
        font-size: 14px;
      ">
        Team modal shell is live. Next step will wire users list + POST to backend.
      </div>
        
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top: 14px;">
        <button id="teamModalCancelBtn" type="button" style="
          padding: 10px 14px;
          border-radius: 10px;
          border: 1px solid #d1d5db;
          background: #fff;
          cursor: pointer;
          font-weight: 600;
        ">Close</button>
      </div>
    </div>
  </div>
</div>
<script src="/js/project-details.js"></script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#3b82f6">
    <title>Photo Documentation - Braxon Mobile</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
        }
        
        /* ===========================
           HEADER STYLES
           =========================== */
        .page-header {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .back-button {
            background: #f1f5f9;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .back-button:active {
            transform: scale(0.9);
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }
        
        .page-subtitle {
            font-size: 14px;
            color: #64748b;
        }
        
        /* ===========================
           SITE TOGGLE
           =========================== */
        .site-toggle-container {
            background: white;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .site-toggle {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 12px;
        }
        
        .site-toggle-btn {
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: transparent;
            color: #64748b;
        }
        
        .site-toggle-btn.active {
            background: white;
            color: #2563eb;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* ===========================
           MODULE CARDS
           =========================== */
        .modules-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .module-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .module-card:active {
            transform: scale(0.98);
        }
        
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }
        
        .module-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .module-info {
            flex: 1;
            margin-left: 16px;
        }
        
        .module-name {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }
        
        .module-label {
            font-size: 13px;
            color: #64748b;
            background: #f1f5f9;
            padding: 4px 10px;
            border-radius: 6px;
            display: inline-block;
        }
        
        .module-status {
            text-align: right;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-badge.complete {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-badge.in-progress {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-badge.not-started {
            background: #f1f5f9;
            color: #64748b;
        }
        
        .module-progress {
            margin-top: 16px;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #64748b;
            margin-bottom: 8px;
        }
        
        .progress-bar {
            height: 8px;
            background: #f1f5f9;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .photo-count {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 12px;
            font-size: 14px;
            color: #64748b;
        }
        
        /* ===========================
           EMPTY STATE
           =========================== */
        .empty-state {
            background: white;
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }
        
        .empty-text {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 24px;
        }
        
        .config-button {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        /* ===========================
           LOADING STATE
           =========================== */
        .loading-container {
            background: white;
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f1f5f9;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    
    <!-- Header -->
    <div class="page-header">
        <div class="header-top">
            <button class="back-button" onclick="window.history.back()">
                <i class="fas fa-arrow-left" style="color: #64748b;"></i>
            </button>
            <div style="flex: 1; text-align: right;">
                <div style="font-size: 12px; color: #64748b; font-weight: 600;" id="completionBadge">
                    Loading...
                </div>
            </div>
        </div>
        <div class="page-title" id="projectName">Photo Documentation</div>
        <div class="page-subtitle" id="projectSubtitle">Loading project...</div>
    </div>
    
    <!-- Site Toggle -->
    <div class="site-toggle-container">
        <div class="site-toggle">
            <button class="site-toggle-btn active" data-site="a" id="siteABtn">
                üìç Site A
            </button>
            <button class="site-toggle-btn" data-site="b" id="siteBBtn">
                üìç Site B
            </button>
        </div>
    </div>
    
    <!-- Modules Container -->
    <div class="modules-container" id="modulesContainer">
        <!-- Loading State -->
        <div class="loading-container">
            <div class="spinner"></div>
            <div style="color: #64748b; font-size: 14px;">Loading modules...</div>
        </div>
    </div>

    <script>
        // ==========================================
        // API CONFIGURATION
        // ==========================================
        const API_BASE = window.location.origin; // ‚úÖ Will be http://localhost:5000
        
        let projectId;
        let currentSite = 'a';
        let modulesData = {};
        
        // ==========================================
        // CHECK AUTHENTICATION
        // ==========================================
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                console.warn('‚ö†Ô∏è Not authenticated, redirecting to login...');
                alert('Please log in first');
                window.location.href = 'mobile-login.html';
                return false;
            }
            return true;
        }
        
        // ==========================================
        // INITIALIZE
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            // Check auth
            if (!checkAuth()) return;
            
            // Get project ID
            const urlParams = new URLSearchParams(window.location.search);
            projectId = urlParams.get('projectId');
            
            if (!projectId) {
                alert('No project specified');
                window.location.href = 'mobile-home.html';
                return;
            }
            
            // Load data
            await loadProjectInfo();
            await loadModules();
            
            // Setup site toggle
            setupSiteToggle();
        });
        
        // ==========================================
        // LOAD PROJECT INFO
        // ==========================================
        async function loadProjectInfo() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/api/projects/${projectId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    const project = result.data;
                    document.getElementById('projectName').textContent = project.project_name || 'Project';
                    document.getElementById('projectSubtitle').textContent = `${project.project_code || ''} ‚Ä¢ Photo Documentation`;
                }
            } catch (error) {
                console.error('Error loading project:', error);
            }
        }
        
        // ==========================================
        // LOAD MODULES
        // ==========================================
async function loadModules() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/api/projects/${projectId}/modules`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const result = await response.json();
                console.log('üì∏ Raw modules data:', result);
                
                if (result.success && result.data) {
                    // The API returns: { success: true, data: { site_A: [...], site_B: [...] } }
                    const siteKey = currentSite === 'a' ? 'site_A' : 'site_B';
                    const modules = result.data[siteKey] || [];
                    
                    console.log(`üì∏ Modules for Site ${currentSite.toUpperCase()}:`, modules);
                    
                    if (modules.length > 0) {
                        // Transform the data to match expected format
                        const transformedModules = modules.map(m => ({
                            id: m.id,
                            module_name: m.module_name,
                            module_description: m.module_description,
                            custom_label: m.custom_label || '',
                            required_photos: m.total_required_photos || 0,
                            uploaded_photos: m.uploaded_photos || 0,
                            completion_percentage: m.total_required_photos > 0 
                                ? Math.round((m.uploaded_photos / m.total_required_photos) * 100) 
                                : 0
                        }));
                        
                        console.log('‚úÖ Transformed modules:', transformedModules);
                        
                        modulesData[currentSite] = transformedModules;
                        renderModules(transformedModules);
                        updateCompletionBadge(transformedModules);
                    } else {
                        console.log(`‚ö†Ô∏è No modules configured for Site ${currentSite.toUpperCase()}`);
                        renderEmptyState();
                    }
                } else {
                    console.log('‚ö†Ô∏è API returned no data');
                    renderEmptyState();
                }
            } catch (error) {
                console.error('‚ùå Error loading modules:', error);
                renderEmptyState();
            }
        }
        
        // ==========================================
        // RENDER MODULES
        // ==========================================
        function renderModules(modules) {
            const container = document.getElementById('modulesContainer');
            
            if (!modules || modules.length === 0) {
                renderEmptyState();
                return;
            }
            
            container.innerHTML = modules.map(module => {
                const completion = module.completion_percentage || 0;
                const isComplete = completion === 100;
                const isInProgress = completion > 0 && completion < 100;
                
                let statusClass = 'not-started';
                let statusText = 'Not Started';
                let statusIcon = '‚è≥';
                
                if (isComplete) {
                    statusClass = 'complete';
                    statusText = 'Complete';
                    statusIcon = '‚úÖ';
                } else if (isInProgress) {
                    statusClass = 'in-progress';
                    statusText = `${completion}%`;
                    statusIcon = 'üì∏';
                }
                
                return `
                    <div class="module-card" onclick="openModuleDetail(${module.id})">
                        <div class="module-header">
                            <div style="display: flex; align-items: start; flex: 1;">
                                <div class="module-icon">${statusIcon}</div>
                                <div class="module-info">
                                    <div class="module-name">${module.module_name}</div>
                                    ${module.custom_label ? `<span class="module-label">${module.custom_label}</span>` : ''}
                                </div>
                            </div>
                            <div class="module-status">
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        
                        <div class="module-progress">
                            <div class="progress-label">
                                <span>Progress</span>
                                <span style="font-weight: 600; color: #1e293b;">${completion}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${completion}%;"></div>
                            </div>
                            <div class="photo-count">
                                <i class="fas fa-camera"></i>
                                <span>${module.uploaded_photos || 0} of ${module.required_photos || 0} photos uploaded</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ==========================================
        // RENDER EMPTY STATE
        // ==========================================
        function renderEmptyState() {
            const container = document.getElementById('modulesContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üì∏</div>
                    <div class="empty-title">No Modules Available</div>
                    <div class="empty-text">
                        No photo modules have been configured for Site ${currentSite.toUpperCase()} yet.
                        <br><br>
                        Please contact your project manager to set up photo documentation modules.
                    </div>
                </div>
            `;
        }
        
        // ==========================================
        // UPDATE COMPLETION BADGE
        // ==========================================
        function updateCompletionBadge(modules) {
            if (!modules || modules.length === 0) {
                document.getElementById('completionBadge').textContent = '0% Complete';
                return;
            }
            
            const totalRequired = modules.reduce((sum, m) => sum + (m.required_photos || 0), 0);
            const totalUploaded = modules.reduce((sum, m) => sum + (m.uploaded_photos || 0), 0);
            const percentage = totalRequired > 0 ? Math.round((totalUploaded / totalRequired) * 100) : 0;
            
            document.getElementById('completionBadge').textContent = `${percentage}% Complete`;
        }
        
        // ==========================================
        // SITE TOGGLE
        // ==========================================
        function setupSiteToggle() {
            const siteABtn = document.getElementById('siteABtn');
            const siteBBtn = document.getElementById('siteBBtn');
            
            siteABtn.addEventListener('click', () => switchSite('a', siteABtn, siteBBtn));
            siteBBtn.addEventListener('click', () => switchSite('b', siteBBtn, siteABtn));
        }
        
        async function switchSite(site, activeBtn, inactiveBtn) {
            if (site === currentSite) return;
            
            currentSite = site;
            
            // Update UI
            activeBtn.classList.add('active');
            inactiveBtn.classList.remove('active');
            
            // Haptic feedback
            if (navigator.vibrate) navigator.vibrate(10);
            
            // Reload modules
            await loadModules();
        }
        
        // ==========================================
        // OPEN MODULE DETAIL
        // ==========================================
        function openModuleDetail(moduleId) {
            window.location.href = `mobile-module-detail.html?projectId=${projectId}&moduleId=${moduleId}&site=${currentSite}`;
        }
    </script>
</body>
</html>
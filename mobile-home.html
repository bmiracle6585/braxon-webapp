<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#3b82f6">
    <title>Dashboard - Braxon Mobile</title>
    
    <link rel="stylesheet" href="css/mobile-modern.css">
    <script src="js/auth.js"></script>
    
    <!-- Leaflet.js for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        /* ===========================
           MODERN HEADER STYLES
           =========================== */
        
        .app-header {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            padding: 24px 20px 32px 20px;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .braxon-logo {
            width: 120px;
            height: auto;
            background: white;
            padding: 8px 12px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .main-content {
            padding-bottom: 100px !important;
        }

        .widgets-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding-bottom: 20px;
        }
        
        .theme-toggle {
            width: 56px;
            height: 32px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .theme-toggle-slider {
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 1px;
            left: 2px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        [data-theme="dark"] .theme-toggle-slider {
            left: 26px;
        }
        
        .theme-toggle-slider svg {
            width: 14px;
            height: 14px;
            color: var(--accent-primary);
        }
        
        .welcome-section {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .welcome-greeting {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.9;
            letter-spacing: 0.3px;
        }
        
        .welcome-name {
            font-size: 28px;
            font-weight: 700;
            line-height: 1.2;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .widget-card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 20px;
            box-shadow: var(--shadow-sm);
        }
        
        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .widget-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 8px;
        }
        
        .action-card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .action-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .action-card:active {
            transform: scale(0.95);
        }
        
        .action-card:active::before {
            opacity: 0.1;
        }
        
        .action-icon {
            width: 48px;
            height: 48px;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .action-icon svg {
            width: 24px;
            height: 24px;
            color: white;
        }
        
        .action-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body>
    
    <header class="app-header">
        <div class="header-top">
            <div class="theme-toggle" id="themeToggle">
                <div class="theme-toggle-slider">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </div>
            </div>
            
            <img src="assets/logo.svg" alt="Braxon Industries" class="braxon-logo">
        </div>
        
        <div class="welcome-section">
            <div class="welcome-greeting" id="greetingText">Good morning</div>
            <div class="welcome-name" id="userName">Blake Miracle</div>
        </div>
    </header>

    <div class="pull-to-refresh" id="pullToRefresh">
        <div class="refresh-spinner"></div>
    </div>

    <main class="main-content" id="mainContent">
        
        <div class="widgets-grid">
            
            <div class="widget-card fade-in" style="animation-delay: 0.1s">
                <div class="widget-header">
                    <h3 class="widget-title">üìÖ Project Schedule</h3>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px;">
                    <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 4px;">This Week</div>
                        <div style="font-size: 11px; opacity: 0.8;" id="thisWeekDates">Loading...</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 12px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 13px; opacity: 0.9; margin-bottom: 4px;">Next Week</div>
                        <div style="font-size: 11px; opacity: 0.8;" id="nextWeekDates">Loading...</div>
                    </div>
                </div>
                
                <!-- TWO-COLUMN SCHEDULE LAYOUT -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <!-- This Week Column (LEFT) -->
                    <div id="thisWeekContainer" style="display: flex; flex-direction: column; gap: 8px; min-height: 100px;">
                        <div style="text-align: center; padding: 1rem; color: var(--text-secondary); font-size: 0.75rem;">Loading...</div>
                    </div>
                    
                    <!-- Next Week Column (RIGHT) -->
                    <div id="nextWeekContainer" style="display: flex; flex-direction: column; gap: 8px; min-height: 100px;">
                        <div style="text-align: center; padding: 1rem; color: var(--text-secondary); font-size: 0.75rem;">Loading...</div>
                    </div>
                </div>
            </div>

            <div class="widget-card fade-in" style="animation-delay: 0.2s">
                <div class="widget-header">
                    <h3 class="widget-title">üó∫Ô∏è Active Project Locations</h3>
                    <div style="display: flex; gap: 8px;">
                        <span style="font-size: 11px; color: #10b981; font-weight: 600;">‚óè This Week</span>
                        <span style="font-size: 11px; color: #3b82f6; font-weight: 600;">‚óè Next Week</span>
                    </div>
                </div>
                
                <div id="projectsMap" style="width: 100%; height: 300px; background: var(--bg-secondary); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 14px;">
                    üìç Map loading...
                </div>
            </div>
            
            <div class="quick-actions fade-in" style="animation-delay: 0.3s">
                <div class="action-card" onclick="window.location.href='daily-report-form.html'">
                    <div class="action-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <span class="action-label">Daily Report</span>
                </div>
                
                <div class="action-card" onclick="window.location.href='receipt-submit.html'">
                    <div class="action-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                    </div>
                    <span class="action-label">Submit Receipt</span>
                </div>
            </div>
            
        </div>
        
    </main>

    <nav class="bottom-nav">
        <a href="mobile-home.html" class="nav-item active">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
            <span class="nav-label">Home</span>
        </a>
        
        <a href="mobile-dashboard-v2.html" class="nav-item">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
            </svg>
            <span class="nav-label">Projects</span>
        </a>
        
        <a href="receipts-list-mobile.html" class="nav-item">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
            </svg>
            <span class="nav-label">Receipts</span>
        </a>
        
        <a href="mobile-tech-portal.html" class="nav-item">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
                <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
            </svg>
            <span class="nav-label">Tech Portal</span>
        </a>
        
        <a href="profile.html" class="nav-item">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            <span class="nav-label">Profile</span>
        </a>
    </nav>

    <script src="js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            initializeTheme();
            initializeUser();
            initializeGreeting();
            initializePullToRefresh();
            
            await loadDashboardData();
        });

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            document.getElementById('themeToggle').addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                if (navigator.vibrate) navigator.vibrate(10);
            });
        }

        function initializeUser() {
            const userName = localStorage.getItem('userName') || 'User';
            document.getElementById('userName').textContent = userName;
        }

        function initializeGreeting() {
            const hour = new Date().getHours();
            let greeting = 'Good morning';
            
            if (hour >= 12 && hour < 17) greeting = 'Good afternoon';
            else if (hour >= 17) greeting = 'Good evening';
            
            document.getElementById('greetingText').textContent = greeting;
        }

        function initializePullToRefresh() {
            const mainContent = document.getElementById('mainContent');
            const pullIndicator = document.getElementById('pullToRefresh');
            let startY = 0;
            let pullDistance = 0;
            let isRefreshing = false;
            
            mainContent.addEventListener('touchstart', (e) => {
                if (mainContent.scrollTop === 0) {
                    startY = e.touches[0].clientY;
                }
            });
            
            mainContent.addEventListener('touchmove', (e) => {
                if (startY === 0 || isRefreshing) return;
                
                const currentY = e.touches[0].clientY;
                pullDistance = currentY - startY;
                
                if (pullDistance > 0 && mainContent.scrollTop === 0) {
                    e.preventDefault();
                    if (pullDistance > 80) pullIndicator.classList.add('active');
                }
            });
            
            mainContent.addEventListener('touchend', async () => {
                if (pullDistance > 80 && !isRefreshing) {
                    isRefreshing = true;
                    await loadDashboardData();
                    setTimeout(() => {
                        pullIndicator.classList.remove('active');
                        isRefreshing = false;
                    }, 500);
                } else {
                    pullIndicator.classList.remove('active');
                }
                startY = 0;
                pullDistance = 0;
            });
        }

        // ========================================
        // COORDINATE PARSING - SAME AS DESKTOP
        // ========================================
        function parseCoordinate(value) {
            if (!value) return null;
            
            // Already a number
            if (typeof value === 'number') return value;
            
            const str = String(value).trim();
            
            // Empty or invalid
            if (!str || str === '0' || str === 'null' || str === 'undefined') return null;
            
            // Decimal degrees (e.g., "34.50521" or "-109.36089")
            const decimalMatch = str.match(/^-?\d+\.?\d*$/);
            if (decimalMatch) {
                const num = parseFloat(str);
                return (num !== 0 && !isNaN(num)) ? num : null;
            }
            
            // DMS format (e.g., "34¬∞27'54.9\"N" or "109¬∞37'41.6\"W")
            const dmsMatch = str.match(/(\d+)[¬∞\s]+(\d+)['\s]+([0-9.]+)["'\s]*([NSEW])?/i);
            if (dmsMatch) {
                const degrees = parseFloat(dmsMatch[1]);
                const minutes = parseFloat(dmsMatch[2]);
                const seconds = parseFloat(dmsMatch[3]);
                const direction = dmsMatch[4] ? dmsMatch[4].toUpperCase() : '';
                
                let decimal = degrees + (minutes / 60) + (seconds / 3600);
                
                // Apply negative for South/West
                if (direction === 'S' || direction === 'W') {
                    decimal = -decimal;
                }
                
                return decimal;
            }
            
            // Fallback: try parseFloat
            const fallback = parseFloat(str);
            return (!isNaN(fallback) && fallback !== 0) ? fallback : null;
        }

        async function loadDashboardData() {
            try {
                const userId = getUserId();
                
                if (!userId) {
                    console.error('No user ID found');
                    document.getElementById('thisWeekContainer').innerHTML = 
                        '<div style="text-align: center; padding: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">Please log in</div>';
                    document.getElementById('nextWeekContainer').innerHTML = 
                        '<div style="text-align: center; padding: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">Please log in</div>';
                    return;
                }
                
                console.log('üîÑ Loading dashboard for user:', userId);
                
                // Try schedule API first
                try {
                    const scheduleResponse = await fetchWithAuth(`/api/project-schedule/user/${userId}`);
                    const scheduleData = await scheduleResponse.json();
                    
                    console.log('üìÖ Schedule data:', scheduleData);
                    
                    if (scheduleData.success && scheduleData.data && scheduleData.data.length > 0) {
                        await loadProjectSchedule(scheduleData.data);
                        await loadProjectLocationsMap(scheduleData.data);
                        return;
                    }
                } catch (e) {
                    console.warn('Schedule API not available, trying projects...');
                }
                
                // Fallback: Load all projects
                const projectsResponse = await fetchWithAuth(`/api/projects`);
                const projectsData = await projectsResponse.json();
                
                console.log('üìÇ Projects data:', projectsData);
                
                if (projectsData.success && projectsData.data) {
                    // Convert projects to schedule items
                    const scheduleItems = projectsData.data
                        .filter(p => p.status === 'in_progress' || p.status === 'pending')
                        .map(project => ({
                            id: project.id,
                            project_id: project.id,
                            schedule_date: project.start_date || new Date().toISOString(),
                            location: project.site_a_name || 'TBD',
                            Project: {
                                ...project,
                                project_name: project.project_name || project.name || 'Unnamed Project',
                                name: project.name || project.project_name || 'Unnamed Project'
                            }
                        }));
                    
                    console.log(`‚úÖ Loaded ${scheduleItems.length} projects as schedule items`);
                    
                    await loadProjectSchedule(scheduleItems);
                    await loadProjectLocationsMap(scheduleItems);
                } else {
                    throw new Error('No data available');
                }
                
            } catch (error) {
                console.error('‚ùå Dashboard error:', error);
                document.getElementById('thisWeekContainer').innerHTML = 
                    '<div style="text-align: center; padding: 0.5rem; color: var(--danger); font-size: 0.75rem;">Error loading</div>';
                document.getElementById('nextWeekContainer').innerHTML = 
                    '<div style="text-align: center; padding: 0.5rem; color: var(--danger); font-size: 0.75rem;">Error loading</div>';
            }
        }

        async function loadProjectSchedule(scheduleData) {
            const thisWeekContainer = document.getElementById('thisWeekContainer');
            const nextWeekContainer = document.getElementById('nextWeekContainer');
            
            if (!scheduleData || scheduleData.length === 0) {
                thisWeekContainer.innerHTML = '<div style="text-align: center; padding: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">No projects</div>';
                nextWeekContainer.innerHTML = '<div style="text-align: center; padding: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">No projects</div>';
                updateWeekDates();
                return;
            }
            
            // Calculate date ranges
            const now = new Date();
            now.setHours(0, 0, 0, 0); // Start of today
            
            const thisWeekEnd = new Date(now);
            thisWeekEnd.setDate(now.getDate() + 6); // Day 7 (inclusive)
            thisWeekEnd.setHours(23, 59, 59, 999);
            
            const nextWeekStart = new Date(now);
            nextWeekStart.setDate(now.getDate() + 7); // Day 8
            nextWeekStart.setHours(0, 0, 0, 0);
            
            const nextWeekEnd = new Date(now);
            nextWeekEnd.setDate(now.getDate() + 13); // Day 14 (inclusive)
            nextWeekEnd.setHours(23, 59, 59, 999);
            
            console.log('üìÜ Date ranges:', {
                now: now.toISOString(),
                thisWeekEnd: thisWeekEnd.toISOString(),
                nextWeekStart: nextWeekStart.toISOString(),
                nextWeekEnd: nextWeekEnd.toISOString()
            });
            
            // Filter projects into two weeks
            const thisWeek = scheduleData.filter(item => {
                const scheduleDate = new Date(item.schedule_date);
                const inRange = scheduleDate >= now && scheduleDate <= thisWeekEnd;
                if (inRange) {
                    console.log('‚úÖ This Week:', item.Project?.project_name, scheduleDate.toISOString());
                }
                return inRange;
            });
            
            const nextWeek = scheduleData.filter(item => {
                const scheduleDate = new Date(item.schedule_date);
                const inRange = scheduleDate >= nextWeekStart && scheduleDate <= nextWeekEnd;
                if (inRange) {
                    console.log('‚úÖ Next Week:', item.Project?.project_name, scheduleDate.toISOString());
                }
                return inRange;
            });
            
            console.log(`üìä Schedule split: ${thisWeek.length} this week, ${nextWeek.length} next week`);
            
            // Render This Week column
            if (thisWeek.length > 0) {
                thisWeekContainer.innerHTML = thisWeek.map(item => renderScheduleItem(item, 'this')).join('');
            } else {
                thisWeekContainer.innerHTML = '<div style="text-align: center; padding: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">No projects</div>';
            }
            
            // Render Next Week column
            if (nextWeek.length > 0) {
                nextWeekContainer.innerHTML = nextWeek.map(item => renderScheduleItem(item, 'next')).join('');
            } else {
                nextWeekContainer.innerHTML = '<div style="text-align: center; padding: 0.5rem; color: var(--text-secondary); font-size: 0.75rem;">No projects</div>';
            }
            
            updateWeekDates();
        }

        function renderScheduleItem(item, week) {
            const date = new Date(item.schedule_date);
            const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
            const dayNum = date.getDate();
            const month = date.toLocaleDateString('en-US', { month: 'short' });
            const borderColor = week === 'this' ? '#10b981' : '#3b82f6';
            
            const projectName = item.Project?.project_name || item.Project?.name || 'Unnamed Project';
            const projectId = item.Project?.id || item.project_id;
            
            // Build location string with BOTH Site A and Site B
            let locationText = '';
            const siteA = item.location || item.Project?.site_a_name;
            const siteB = item.Project?.site_b_name;
            
            if (siteA && siteB && siteA !== siteB) {
                locationText = `${siteA} ‚Üí ${siteB}`;
            } else if (siteA) {
                locationText = siteA;
            } else if (siteB) {
                locationText = siteB;
            } else {
                locationText = 'TBD';
            }
            
            return `
                <div style="background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid ${borderColor}; padding: 10px; display: flex; flex-direction: column; gap: 8px;">
                    <!-- Date Badge -->
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="background: ${borderColor}; color: white; width: 32px; height: 32px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 700; line-height: 1;">
                                <div style="font-size: 0.65rem; opacity: 0.8;">${month}</div>
                                <div style="font-size: 1rem;">${dayNum}</div>
                            </div>
                            <div style="font-size: 0.65rem; color: var(--text-secondary); font-weight: 600;">${dayName}</div>
                        </div>
                        
                        <a href="project-details.html?id=${projectId}" 
                           style="background: ${borderColor}; color: white; width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; text-decoration: none; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </a>
                    </div>
                    
                    <!-- Project Info -->
                    <div>
                        <div style="font-size: 0.8rem; font-weight: 700; color: var(--text-primary); margin-bottom: 4px; line-height: 1.2;">
                            ${projectName}
                        </div>
                        <div style="font-size: 0.7rem; color: var(--text-secondary); display: flex; align-items: center; gap: 4px; line-height: 1.3;">
                            üìç ${locationText}
                        </div>
                        ${item.start_time ? `
                            <div style="font-size: 0.7rem; color: ${borderColor}; font-weight: 600; margin-top: 4px;">
                                üïê ${item.start_time}${item.end_time ? '-' + item.end_time : ''}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function updateWeekDates() {
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            
            const thisWeekEnd = new Date(now);
            thisWeekEnd.setDate(now.getDate() + 6);
            
            const nextWeekStart = new Date(now);
            nextWeekStart.setDate(now.getDate() + 7);
            
            const nextWeekEnd = new Date(now);
            nextWeekEnd.setDate(now.getDate() + 13);
            
            document.getElementById('thisWeekDates').textContent = 
                `${now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${thisWeekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            
            document.getElementById('nextWeekDates').textContent = 
                `${nextWeekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${nextWeekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
        }

        let map = null;
        let markers = [];

        async function loadProjectLocationsMap(scheduleData) {
            const mapContainer = document.getElementById('projectsMap');
            
            if (!scheduleData || scheduleData.length === 0) {
                mapContainer.innerHTML = '<div style="color: var(--text-secondary);">No projects to display</div>';
                return;
            }
            
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            
            const thisWeekEnd = new Date(now);
            thisWeekEnd.setDate(now.getDate() + 6);
            thisWeekEnd.setHours(23, 59, 59, 999);
            
            const nextWeekEnd = new Date(now);
            nextWeekEnd.setDate(now.getDate() + 13);
            nextWeekEnd.setHours(23, 59, 59, 999);
            
            const relevantSchedule = scheduleData.filter(item => {
                const scheduleDate = new Date(item.schedule_date);
                return scheduleDate >= now && scheduleDate <= nextWeekEnd;
            });
            
            const locations = [];
            
            relevantSchedule.forEach(scheduleItem => {
                const project = scheduleItem.Project;
                if (!project) return;
                
                const scheduleDate = new Date(scheduleItem.schedule_date);
                const isThisWeek = scheduleDate <= thisWeekEnd;
                const timeFrame = isThisWeek ? 'This Week' : 'Next Week';
                const markerColor = isThisWeek ? '#10b981' : '#3b82f6';
                
                const projectName = project.project_name || project.name || 'Unnamed Project';
                
                // Site A - USE COORDINATE PARSER
                const siteALat = parseCoordinate(project.site_a_latitude);
                const siteALng = parseCoordinate(project.site_a_longitude);
                
                if (siteALat !== null && siteALng !== null) {
                    console.log(`‚úÖ Site A coords: ${projectName} - ${siteALat}, ${siteALng}`);
                    locations.push({
                        lat: siteALat,
                        lng: siteALng,
                        name: project.site_a_name || 'Site A',
                        address: project.site_a_address,
                        location: project.site_a_location,
                        projectName: projectName,
                        projectCode: project.project_code,
                        timeFrame: timeFrame,
                        color: markerColor,
                        isThisWeek: isThisWeek,
                        startTime: scheduleItem.start_time,
                        endTime: scheduleItem.end_time,
                        scheduleDate: scheduleDate
                    });
                } else {
                    console.warn(`‚ö†Ô∏è Site A invalid coords: ${projectName} - lat:${project.site_a_latitude} lng:${project.site_a_longitude}`);
                }
                
                // Site B - USE COORDINATE PARSER
                const siteBLat = parseCoordinate(project.site_b_latitude);
                const siteBLng = parseCoordinate(project.site_b_longitude);
                
                if (siteBLat !== null && siteBLng !== null) {
                    console.log(`‚úÖ Site B coords: ${projectName} - ${siteBLat}, ${siteBLng}`);
                    locations.push({
                        lat: siteBLat,
                        lng: siteBLng,
                        name: project.site_b_name || 'Site B',
                        address: project.site_b_address,
                        location: project.site_b_location,
                        projectName: projectName,
                        projectCode: project.project_code,
                        timeFrame: timeFrame,
                        color: markerColor,
                        isThisWeek: isThisWeek,
                        startTime: scheduleItem.start_time,
                        endTime: scheduleItem.end_time,
                        scheduleDate: scheduleDate
                    });
                } else {
                    console.warn(`‚ö†Ô∏è Site B invalid coords: ${projectName} - lat:${project.site_b_latitude} lng:${project.site_b_longitude}`);
                }
            });
            
            if (locations.length === 0) {
                mapContainer.innerHTML = `
                    <div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;">
                        <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--accent-primary);">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <div style="font-size: 14px; color: var(--text-primary); font-weight: 600;">${relevantSchedule.length} Scheduled Project${relevantSchedule.length !== 1 ? 's' : ''}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">No GPS coordinates available</div>
                    </div>
                `;
                return;
            }
            
            if (map) {
                map.remove();
                map = null;
            }
            
            mapContainer.innerHTML = '';
            mapContainer.style.display = 'block';
            
            map = L.map('projectsMap', {
                zoomControl: true,
                scrollWheelZoom: false,
                dragging: true,
                tap: true,
                touchZoom: true
            }).setView([31.9686, -99.9018], 6);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            
            const greenIcon = L.divIcon({
                className: 'custom-marker',
                html: '<div style="background: #10b981; width: 32px; height: 32px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"><div style="transform: rotate(45deg); color: white; font-size: 16px; text-align: center; line-height: 26px;">üìç</div></div>',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });
            
            const blueIcon = L.divIcon({
                className: 'custom-marker',
                html: '<div style="background: #3b82f6; width: 32px; height: 32px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"><div style="transform: rotate(45deg); color: white; font-size: 16px; text-align: center; line-height: 26px;">üìç</div></div>',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });
            
            const bounds = [];
            
            locations.forEach(loc => {
                const icon = loc.isThisWeek ? greenIcon : blueIcon;
                const marker = L.marker([loc.lat, loc.lng], { icon: icon }).addTo(map);
                
                const dateStr = loc.scheduleDate.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                const popupContent = `
                    <div style="font-family: -apple-system, sans-serif; min-width: 220px;">
                        <div style="font-size: 16px; font-weight: 700; color: #1a1a1a; margin-bottom: 4px;">
                            ${loc.projectName}
                        </div>
                        ${loc.projectCode ? `
                            <div style="font-size: 11px; color: #888; margin-bottom: 8px; font-family: monospace;">
                                ${loc.projectCode}
                            </div>
                        ` : ''}
                        <div style="font-size: 13px; color: ${loc.color}; font-weight: 700; margin-bottom: 8px; padding: 4px 8px; background: ${loc.color}22; border-radius: 6px; display: inline-block;">
                            üìÖ ${loc.timeFrame} - ${dateStr}
                        </div>
                        <div style="font-size: 14px; color: #333; font-weight: 600; margin-bottom: 4px; margin-top: 8px;">
                            üìç ${loc.name}
                        </div>
                        ${loc.location ? `
                            <div style="font-size: 12px; color: #666; margin-bottom: 4px;">
                                ${loc.location}
                            </div>
                        ` : ''}
                        ${loc.address ? `
                            <div style="font-size: 11px; color: #888; margin-bottom: 8px;">
                                ${loc.address}
                            </div>
                        ` : ''}
                        ${loc.startTime ? `
                            <div style="font-size: 12px; color: #666; margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee;">
                                üïê ${loc.startTime}${loc.endTime ? ' - ' + loc.endTime : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                marker.bindPopup(popupContent, {
                    maxWidth: 300,
                    className: 'custom-popup'
                });
                
                bounds.push([loc.lat, loc.lng]);
                markers.push(marker);
            });
            
            if (bounds.length > 0) {
                map.fitBounds(bounds, {
                    padding: [50, 50],
                    maxZoom: 13
                });
            }
            
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
            
            console.log(`üìç Map loaded with ${locations.length} location(s) from ${relevantSchedule.length} scheduled project(s)`);
        }
    </script>
</body>
</html>
const express = require('express');
const router = express.Router();
const db = require('../config/database');
const { authenticateToken } = require('../middleware/auth');

// ============================================
// GET ALL DAILY REPORTS (with filters)
// ============================================
router.get('/', authenticateToken, async (req, res) => {
    try {
        const { project_id, start_date, end_date, status } = req.query;
        
        let query = `
            SELECT 
                dr.*,
                p.project_name,
                p.project_code,
                u.name as submitted_by_name,
                u.email as submitted_by_email
            FROM daily_reports dr
            LEFT JOIN projects p ON dr.project_id = p.id
            LEFT JOIN users u ON dr.submitted_by = u.id
            WHERE 1=1
        `;
        
        const params = [];
        
        if (project_id) {
            query += ` AND dr.project_id = $${params.length + 1}`;
            params.push(project_id);
        }
        
        if (start_date) {
            query += ` AND dr.report_date >= $${params.length + 1}`;
            params.push(start_date);
        }
        
        if (end_date) {
            query += ` AND dr.report_date <= $${params.length + 1}`;
            params.push(end_date);
        }
        
        if (status) {
            query += ` AND dr.status = $${params.length + 1}`;
            params.push(status);
        }
        
        query += ` ORDER BY dr.report_date DESC, dr.created_at DESC`;
        
        const result = await db.query(query, params);
        
        res.json({
            success: true,
            data: result.rows,
            count: result.rows.length
        });
    } catch (error) {
        console.error('Error fetching daily reports:', error);
        res.status(500).json({
            success: false,
            message: 'Error fetching daily reports',
            error: error.message
        });
    }
});

// ============================================
// GET LATEST DAILY REPORT FOR A PROJECT
// ============================================
router.get('/project/:projectId/latest', authenticateToken, async (req, res) => {
    try {
        const { projectId } = req.params;
        
        const query = `
            SELECT 
                dr.*,
                u.name as submitted_by_name,
                u.email as submitted_by_email,
                p.project_name
            FROM daily_reports dr
            LEFT JOIN users u ON dr.submitted_by = u.id
            LEFT JOIN projects p ON dr.project_id = p.id
            WHERE dr.project_id = $1
                AND dr.status = 'submitted'
            ORDER BY dr.report_date DESC, dr.created_at DESC
            LIMIT 1
        `;
        
        const result = await db.query(query, [projectId]);
        
        if (result.rows.length === 0) {
            return res.json({
                success: true,
                data: null,
                message: 'No daily reports found for this project'
            });
        }
        
        res.json({
            success: true,
            data: result.rows[0]
        });
    } catch (error) {
        console.error('Error fetching latest report:', error);
        res.status(500).json({
            success: false,
            message: 'Error fetching latest report',
            error: error.message
        });
    }
});

// ============================================
// GET CONCERNS/CHANGE ORDERS FOR A PROJECT
// ============================================
router.get('/project/:projectId/concerns', authenticateToken, async (req, res) => {
    try {
        const { projectId } = req.params;
        
        const query = `
            SELECT 
                dr.id as report_id,
                dr.report_date,
                dr.issues_concerns,
                dr.site,
                dr.status,
                u.name as reported_by_name,
                u.email as reported_by_email
            FROM daily_reports dr
            LEFT JOIN users u ON dr.submitted_by = u.id
            WHERE dr.project_id = $1
                AND dr.issues_concerns IS NOT NULL
                AND dr.issues_concerns != ''
                AND dr.status = 'submitted'
            ORDER BY dr.report_date DESC
        `;
        
        const result = await db.query(query, [projectId]);
        
        res.json({
            success: true,
            data: result.rows,
            count: result.rows.length
        });
    } catch (error) {
        console.error('Error fetching concerns:', error);
        res.status(500).json({
            success: false,
            message: 'Error fetching concerns',
            error: error.message
        });
    }
});

// ============================================
// GET SINGLE DAILY REPORT BY ID
// ============================================
router.get('/:id', authenticateToken, async (req, res) => {
    try {
        const { id } = req.params;
        
        const query = `
            SELECT 
                dr.*,
                p.project_name,
                p.project_code,
                u.name as submitted_by_name,
                u.email as submitted_by_email
            FROM daily_reports dr
            LEFT JOIN projects p ON dr.project_id = p.id
            LEFT JOIN users u ON dr.submitted_by = u.id
            WHERE dr.id = $1
        `;
        
        const result = await db.query(query, [id]);
        
        if (result.rows.length === 0) {
            return res.status(404).json({
                success: false,
                message: 'Daily report not found'
            });
        }
        
        res.json({
            success: true,
            data: result.rows[0]
        });
    } catch (error) {
        console.error('Error fetching daily report:', error);
        res.status(500).json({
            success: false,
            message: 'Error fetching daily report',
            error: error.message
        });
    }
});

// ============================================
// CREATE NEW DAILY REPORT
// ============================================
router.post('/', authenticateToken, async (req, res) => {
    try {
        const {
            project_id,
            report_date,
            site,
            weather_conditions,
            crew_time,
            work_description,
            customer_contact,
            customer_notes,
            general_notes,
            issues_concerns
        } = req.body;
        
        const submitted_by = req.user.userId;
        
        // Validate required fields
        if (!project_id || !report_date) {
            return res.status(400).json({
                success: false,
                message: 'Project ID and report date are required'
            });
        }
        
        const query = `
            INSERT INTO daily_reports (
                project_id,
                submitted_by,
                report_date,
                site,
                weather_conditions,
                crew_time,
                work_description,
                customer_contact,
                customer_notes,
                general_notes,
                issues_concerns,
                status,
                created_at,
                updated_at
            ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, 'draft', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
            RETURNING *
        `;
        
        const values = [
            project_id,
            submitted_by,
            report_date,
            site || null,
            weather_conditions || null,
            crew_time ? JSON.stringify(crew_time) : null,
            work_description || null,
            customer_contact || false,
            customer_notes || null,
            general_notes || null,
            issues_concerns || null
        ];
        
        const result = await db.query(query, values);
        
        res.status(201).json({
            success: true,
            message: 'Daily report created successfully',
            data: result.rows[0]
        });
    } catch (error) {
        console.error('Error creating daily report:', error);
        res.status(500).json({
            success: false,
            message: 'Error creating daily report',
            error: error.message
        });
    }
});

// ============================================
// UPDATE DAILY REPORT
// ============================================
router.put('/:id', authenticateToken, async (req, res) => {
    try {
        const { id } = req.params;
        const {
            report_date,
            site,
            weather_conditions,
            crew_time,
            work_description,
            customer_contact,
            customer_notes,
            general_notes,
            issues_concerns,
            status
        } = req.body;
        
        const query = `
            UPDATE daily_reports
            SET 
                report_date = COALESCE($1, report_date),
                site = COALESCE($2, site),
                weather_conditions = COALESCE($3, weather_conditions),
                crew_time = COALESCE($4, crew_time),
                work_description = COALESCE($5, work_description),
                customer_contact = COALESCE($6, customer_contact),
                customer_notes = COALESCE($7, customer_notes),
                general_notes = COALESCE($8, general_notes),
                issues_concerns = COALESCE($9, issues_concerns),
                status = COALESCE($10, status),
                updated_at = CURRENT_TIMESTAMP
            WHERE id = $11
            RETURNING *
        `;
        
        const values = [
            report_date,
            site,
            weather_conditions,
            crew_time ? JSON.stringify(crew_time) : null,
            work_description,
            customer_contact,
            customer_notes,
            general_notes,
            issues_concerns,
            status,
            id
        ];
        
        const result = await db.query(query, values);
        
        if (result.rows.length === 0) {
            return res.status(404).json({
                success: false,
                message: 'Daily report not found'
            });
        }
        
        res.json({
            success: true,
            message: 'Daily report updated successfully',
            data: result.rows[0]
        });
    } catch (error) {
        console.error('Error updating daily report:', error);
        res.status(500).json({
            success: false,
            message: 'Error updating daily report',
            error: error.message
        });
    }
});

// ============================================
// SUBMIT DAILY REPORT (Change status to submitted)
// ============================================
router.put('/:id/submit', authenticateToken, async (req, res) => {
    try {
        const { id } = req.params;
        
        const query = `
            UPDATE daily_reports
            SET 
                status = 'submitted',
                submitted_at = CURRENT_TIMESTAMP,
                updated_at = CURRENT_TIMESTAMP
            WHERE id = $1
            RETURNING *
        `;
        
        const result = await db.query(query, [id]);
        
        if (result.rows.length === 0) {
            return res.status(404).json({
                success: false,
                message: 'Daily report not found'
            });
        }
        
        res.json({
            success: true,
            message: 'Daily report submitted successfully',
            data: result.rows[0]
        });
    } catch (error) {
        console.error('Error submitting daily report:', error);
        res.status(500).json({
            success: false,
            message: 'Error submitting daily report',
            error: error.message
        });
    }
});

// ============================================
// DELETE DAILY REPORT
// ============================================
router.delete('/:id', authenticateToken, async (req, res) => {
    try {
        const { id } = req.params;
        
        const query = 'DELETE FROM daily_reports WHERE id = $1 RETURNING *';
        const result = await db.query(query, [id]);
        
        if (result.rows.length === 0) {
            return res.status(404).json({
                success: false,
                message: 'Daily report not found'
            });
        }
        
        res.json({
            success: true,
            message: 'Daily report deleted successfully'
        });
    } catch (error) {
        console.error('Error deleting daily report:', error);
        res.status(500).json({
            success: false,
            message: 'Error deleting daily report',
            error: error.message
        });
    }
});

module.exports = router;